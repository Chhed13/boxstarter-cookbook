<%= @code %>
if(Test-PendingReboot) {Invoke-Reboot}
if(!(Test-ChildOfRuby)){Chef-Client}

function Test-ChildOfRuby($ID = $PID) {
   $parent = (Get-WmiObject -Class Win32_Process -Filter "ProcessID=$ID").ParentProcessID 
    if($parent -eq $null) { return $false } else {
    	$parentProc = Get-WmiObject -Class Win32_Process -Filter "ProcessID=$parent"
    	if($parentProc.Name -eq "Ruby.exe") {return $true} else {
    		return Test-ChildOfRuby $parent
    	}
    }
} 